<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Scope Change Approval</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #F8FAFC; color: #1E293B; line-height: 1.5; padding: 16px; min-height: 100vh; }
    .container { max-width: 480px; margin: 0 auto; }
    .card { background: #FFFFFF; border-radius: 12px; border: 1px solid #E2E8F0; padding: 24px; margin-bottom: 16px; }
    .header { text-align: center; margin-bottom: 24px; }
    .header h1 { font-size: 20px; font-weight: 700; color: #1E293B; margin-bottom: 4px; }
    .header p { font-size: 14px; color: #64748B; }
    .detail-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #F1F5F9; }
    .detail-row:last-child { border-bottom: none; }
    .detail-label { font-size: 14px; color: #64748B; }
    .detail-value { font-size: 14px; font-weight: 600; color: #1E293B; text-align: right; max-width: 60%; }
    .cost-highlight { background: #EFF6FF; border-radius: 8px; padding: 16px; text-align: center; margin: 16px 0; }
    .cost-highlight .label { font-size: 13px; color: #64748B; margin-bottom: 4px; }
    .cost-highlight .amount { font-size: 28px; font-weight: 700; color: #2563EB; }
    .description { font-size: 14px; color: #475569; background: #F8FAFC; border-radius: 8px; padding: 12px; margin: 12px 0; white-space: pre-wrap; }
    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 6px; }
    .form-group input, .form-group textarea { width: 100%; padding: 10px 12px; border: 1px solid #D1D5DB; border-radius: 8px; font-size: 14px; font-family: inherit; }
    .form-group input:focus, .form-group textarea:focus { outline: none; border-color: #2563EB; box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }
    .form-group textarea { resize: vertical; min-height: 80px; }
    .btn { display: block; width: 100%; padding: 14px; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; text-align: center; transition: opacity 0.2s; }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .btn-approve { background: #22C55E; color: #FFFFFF; margin-bottom: 12px; }
    .btn-reject { background: #FFFFFF; color: #EF4444; border: 1px solid #FCA5A5; }
    .btn-approve:hover:not(:disabled) { opacity: 0.9; }
    .btn-reject:hover:not(:disabled) { background: #FEF2F2; }
    .notes-section { display: none; margin-top: 16px; }
    .notes-section.visible { display: block; }
    .btn-submit-reject { background: #EF4444; color: #FFFFFF; margin-top: 12px; }
    .success-icon { font-size: 48px; text-align: center; margin-bottom: 12px; }
    .msg { text-align: center; padding: 40px 20px; }
    .msg h2 { font-size: 18px; margin-bottom: 8px; }
    .msg p { color: #64748B; font-size: 14px; }
    .field-error { color: #EF4444; font-size: 13px; margin-top: 4px; display: none; }
    .spinner { display: inline-block; width: 18px; height: 18px; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: #fff; animation: spin 0.6s linear infinite; vertical-align: middle; margin-right: 8px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading-dots { text-align: center; padding: 60px 20px; }
    .loading-dots span { display: inline-block; width: 10px; height: 10px; margin: 0 4px; background: #94A3B8; border-radius: 50%; animation: bounce 1.4s ease-in-out infinite; }
    .loading-dots span:nth-child(1) { animation-delay: -0.32s; }
    .loading-dots span:nth-child(2) { animation-delay: -0.16s; }
    @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
  </style>
</head>
<body>
  <div class="container">
    <!-- Loading state -->
    <div id="loading-view" class="card">
      <div class="loading-dots">
        <span></span><span></span><span></span>
      </div>
      <p style="text-align:center; color:#64748B; margin-top:12px;">Loading approval details...</p>
    </div>

    <!-- Error / message state -->
    <div id="message-view" style="display:none;"></div>

    <!-- Main approval content -->
    <div id="approval-view" style="display:none;">
      <div class="header">
        <h1 id="company-name"></h1>
        <p>Scope Change Approval Request</p>
      </div>

      <div class="card">
        <div class="detail-row">
          <span class="detail-label">Project</span>
          <span class="detail-value" id="project-name"></span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Scope Change</span>
          <span class="detail-value" id="sc-title"></span>
        </div>
        <div id="sc-description-wrap" style="display:none;">
          <div class="description" id="sc-description"></div>
        </div>
        <div class="detail-row">
          <span class="detail-label">Estimated Hours</span>
          <span class="detail-value" id="sc-hours"></span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Rate</span>
          <span class="detail-value" id="sc-rate"></span>
        </div>
        <div class="cost-highlight">
          <div class="label">Total Cost</div>
          <div class="amount" id="sc-cost"></div>
        </div>
      </div>

      <div class="card" id="action-card">
        <div class="form-group">
          <label for="client_name">Your Name *</label>
          <input type="text" id="client_name" required />
          <div class="field-error" id="name-error">Name is required</div>
        </div>
        <div class="form-group">
          <label for="client_email">Your Email (optional)</label>
          <input type="email" id="client_email" />
        </div>

        <button class="btn btn-approve" id="approve-btn" onclick="handleApprove()">Approve</button>
        <button class="btn btn-reject" id="reject-btn" onclick="showRejectForm()">Request Changes</button>

        <div class="notes-section" id="notes-section">
          <div class="form-group">
            <label for="notes">What changes would you like? *</label>
            <textarea id="notes" placeholder="Describe the changes you'd like..."></textarea>
            <div class="field-error" id="notes-error">Please describe the changes you'd like</div>
          </div>
          <button class="btn btn-submit-reject" id="submit-reject-btn" onclick="handleReject()">Submit Feedback</button>
        </div>
      </div>

      <div class="card msg" id="result-card" style="display:none;"></div>
    </div>
  </div>

  <script>
    // Extract config from URL
    var params = new URLSearchParams(window.location.search);
    var TOKEN = params.get('token');
    // Supabase project URL (hardcoded since page is hosted externally)
    var SUPABASE_URL = 'https://ynjnxmptffdoybhkgmuf.supabase.co';
    var API_URL = SUPABASE_URL + '/functions/v1/client-approval';

    function showMessage(icon, title, message) {
      document.getElementById('loading-view').style.display = 'none';
      document.getElementById('approval-view').style.display = 'none';
      var el = document.getElementById('message-view');
      el.style.display = 'block';
      el.innerHTML = '<div class="card msg"><div class="success-icon">' + icon + '</div><h2>' + title + '</h2><p>' + message + '</p></div>';
    }

    function formatCurrency(amount, currency) {
      try {
        return new Intl.NumberFormat('en-US', { style: 'currency', currency: currency, minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(amount);
      } catch(e) {
        return '$' + amount.toFixed(2);
      }
    }

    // Load data from the edge function
    function loadApprovalData() {
      if (!TOKEN) {
        showMessage('&#10060;', 'Invalid Link', 'This approval link is missing required parameters.');
        return;
      }

      fetch(API_URL + '?token=' + encodeURIComponent(TOKEN))
        .then(function(res) {
          return res.json().then(function(data) { return { status: res.status, data: data }; });
        })
        .then(function(result) {
          var status = result.status;
          var data = result.data;

          if (status === 404) {
            showMessage('&#10060;', 'Link Not Found', 'This approval link is invalid or has been reset.');
            return;
          }

          if (status === 409) {
            var statusMsg = data.approval_status === 'client_approved'
              ? 'This scope change has already been approved.'
              : data.approval_status === 'client_rejected'
              ? 'Changes have already been requested for this scope change.'
              : 'This approval link is no longer active.';
            showMessage('&#9989;', 'Already Responded', statusMsg);
            return;
          }

          if (status !== 200 || data.error) {
            showMessage('&#10060;', 'Error', data.error || 'Something went wrong.');
            return;
          }

          // Render the approval page
          var sc = data.scope_change;
          var proj = data.project;
          var prof = data.profile;
          var currency = proj.currency || 'USD';
          var hours = parseFloat(sc.estimated_hours) || 0;
          var rate = sc.rate_override ? parseFloat(sc.rate_override) : (parseFloat(proj.hourly_rate) || 0);
          var cost = parseFloat(sc.calculated_cost) || 0;

          document.getElementById('company-name').textContent = prof.company_name || prof.full_name || 'Freelancer';
          document.getElementById('project-name').textContent = proj.project_name;
          document.getElementById('sc-title').textContent = sc.title;
          document.getElementById('sc-hours').textContent = hours + ' hrs';
          document.getElementById('sc-rate').textContent = formatCurrency(rate, currency) + '/hr';
          document.getElementById('sc-cost').textContent = formatCurrency(cost, currency);
          document.title = 'Approve Scope Change - ' + proj.project_name;

          if (sc.description) {
            document.getElementById('sc-description').textContent = sc.description;
            document.getElementById('sc-description-wrap').style.display = 'block';
          }

          if (sc.approval_client_name) {
            document.getElementById('client_name').value = sc.approval_client_name;
          } else if (proj.client_name) {
            document.getElementById('client_name').value = proj.client_name;
          }

          if (sc.approval_client_email) {
            document.getElementById('client_email').value = sc.approval_client_email;
          }

          document.getElementById('loading-view').style.display = 'none';
          document.getElementById('approval-view').style.display = 'block';
        })
        .catch(function(err) {
          showMessage('&#10060;', 'Connection Error', 'Could not load approval details. Please check your internet connection and try again.');
        });
    }

    function showRejectForm() {
      document.getElementById('notes-section').classList.add('visible');
      document.getElementById('reject-btn').style.display = 'none';
    }

    function setLoading(btnId, loading) {
      var btn = document.getElementById(btnId);
      if (loading) {
        btn.disabled = true;
        btn.dataset.origText = btn.textContent;
        btn.innerHTML = '<span class="spinner"></span>Submitting...';
      } else {
        btn.disabled = false;
        btn.textContent = btn.dataset.origText;
      }
    }

    function showResult(icon, title, message) {
      document.getElementById('action-card').style.display = 'none';
      var result = document.getElementById('result-card');
      result.style.display = 'block';
      result.innerHTML = '<div class="success-icon">' + icon + '</div><h2>' + title + '</h2><p>' + message + '</p>';
    }

    function submitAction(action, notes) {
      var clientName = document.getElementById('client_name').value.trim();
      var clientEmail = document.getElementById('client_email').value.trim();

      if (!clientName) {
        document.getElementById('name-error').style.display = 'block';
        return Promise.resolve(false);
      }
      document.getElementById('name-error').style.display = 'none';

      if (action === 'reject' && !notes) {
        document.getElementById('notes-error').style.display = 'block';
        return Promise.resolve(false);
      }

      var body = { token: TOKEN, action: action, client_name: clientName };
      if (clientEmail) body.client_email = clientEmail;
      if (notes) body.notes = notes;

      return fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
      }).then(function(res) {
        return res.json().then(function(data) {
          if (!res.ok) throw new Error(data.error || 'Something went wrong');
          return true;
        });
      });
    }

    function handleApprove() {
      setLoading('approve-btn', true);
      submitAction('approve').then(function(ok) {
        if (ok) showResult('\u2705', 'Approved!', 'The scope change has been approved. The freelancer has been notified.');
        else setLoading('approve-btn', false);
      }).catch(function(e) {
        setLoading('approve-btn', false);
        alert(e.message);
      });
    }

    function handleReject() {
      var notes = document.getElementById('notes').value.trim();
      if (!notes) {
        document.getElementById('notes-error').style.display = 'block';
        return;
      }
      document.getElementById('notes-error').style.display = 'none';

      setLoading('submit-reject-btn', true);
      submitAction('reject', notes).then(function(ok) {
        if (ok) showResult('\u270F\uFE0F', 'Feedback Submitted', 'Your feedback has been sent. The freelancer will review your requested changes.');
        else setLoading('submit-reject-btn', false);
      }).catch(function(e) {
        setLoading('submit-reject-btn', false);
        alert(e.message);
      });
    }

    // Start loading
    loadApprovalData();
  </script>
</body>
</html>
